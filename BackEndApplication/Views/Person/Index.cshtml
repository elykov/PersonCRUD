
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Persons"; 
}

<style>
    .card {
        background-color: #303030;
        display: block;
        padding: 6px;
        margin-bottom: 10px;
        border: 1.8px solid #696969;
        border-radius: 8px;
    }
</style>

<div class="text-center">
    <h2>This is test project which implements CRUD operations for object Person.</h2>
    <h4>Application uses WebAPI to manage data. Know more on 
    <a href="http://hapi.fhir.org/resource?encoding=null&pretty=true&resource=Person">this site</a>.
    <br />
    If you want know more about person <a href="http://www.hl7.org/fhir/person.html#resource">click here</a>.</h4>
    <h3>To <a href="/Person/Edit" class="btn btn-primary btn-lg">Create new person</a> click this button.</h3>
</div>
<br />
<div class="container">
    
    <div id="all-persons" style="display: none;" data-bind="visible: persons().length != 0">
        <div class="row" data-bind="foreach: persons">
            <div class="col-md-6" data-bind="attr: { id: resource.id }">
                <div class="card">
                    <!-- ko if: resource.id -->
                    <p data-bind="text: `Person Id: ${resource.id}`"></p>
                    <!-- /ko -->
                    <!-- ko if: resource.gender -->
                    <p data-bind="text: `Gender: ${resource.gender}`"></p>
                    <!-- /ko -->
                    <!-- ko if: resource.birthDate -->
                    <p data-bind="text: `BirthDate: ${resource.birthDate}`"></p>
                    <!-- /ko -->
                    <!-- ko if: $data.resource.name -->
                    <p data-bind="text: `Name: ${resource.name[0].family}`"></p>
                    <!-- /ko -->
                    <!-- ko if: resource.telecom -->
                    <p>
                        Telecom:

                        <span data-bind="text: `${resource.telecom[0]} `"></span>
                    </p>
                    <!-- /ko -->
                    <!-- ko if: resource.address -->
                    <p>
                        Address: <span data-bind="text: `${resource.address[0]} `"></span>
                    </p>
                    <!-- /ko -->

                    <div>
                        <a class="btn btn-primary" data-bind="attr: { href: '/Person/Edit/' + resource.id}">Edit</a>
                        <button data-bind="click: deletePerson.bind($parent)" class="btn btn-danger">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @*<table class="table table-bordered table-hover text-center">
        <tbody>
            <tr>
                <td></td>
            </tr>
            <tr>
                <td></td>
            </tr>
        </tbody>
    </table>*@

</div>
@section Scripts {
    <script type="text/javascript">
        $(() => {
            const siteUrl = "https://hapi.fhir.org/baseR4/Person";
            var self = this;
            self.persons = null;
            loadData();

            function loadData() {
                $.ajax({
                    url: siteUrl,
                    type: 'GET',
                    //contentType: "application/json",
                    success: function (data) {
                        console.log(data);
                        console.log(data.entry);
                        self.persons = ko.observableArray(data.entry);
                        ko.applyBindings(self);
                    },
                    error: function (data) {
                        alert("error");
                        console.log(data);
                    }
                });
            }

            self.deletePerson = function (pers) {
                let id = pers.resource.id;
                console.log(id);

                if (confirm(`You sure you want to delete this person with Id = ${id}?`)) {
                    $.ajax({
                        url: siteUrl + `/${id}`,
                        type: 'DELETE',
                        contentType: "application/json",
                        data: { id: id },
                        success: (data) => {
                            alert("Delete query succussful! Person will be deleted soon.");
                            self.persons.remove(pers);
                            console.log(data);
                        },
                        error: (data) => {
                            alert("error");
                            console.log(data);
                        }
                    });
                }
            }
        });
    </script>
}