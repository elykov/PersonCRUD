
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Persons"; 
}

<h3>Lorem ipsum dolor sit amet consectetur adipisicing elit. Nihil perferendis adipisci sit cupiditate aliquid natus nemo dolores nam vel accusamus, harum tempore ratione fuga repellendus? Nesciunt deserunt nostrum incidunt perferendis!</h3>
<br />
<div class="container">
    <div id="all-persons" style="display: none;" data-bind="visible: persons().length != 0">
        <div class="row" data-bind="foreach: persons">
            <div class="col-md-6" data-bind="attr: { id: resource.id }">
                <div class="thumbnail">
                    <!-- ko if: resource.id -->
                    <p>Person Id: <span data-bind="text: resource.id"></span></p>
                    <!-- /ko -->
                    <!-- ko if: resource.gender -->
                    <p>Gender: <span data-bind="text: resource.gender"></span></p>
                    <!-- /ko -->
                    <!-- ko if: resource.birthDate -->
                    <p>BirthDate: <span data-bind="text: resource.birthDate"></span></p>
                    <!-- /ko -->
                    <!-- ko if: resource.name -->
                    <p>Name: <span data-bind="text: `${resource.name[0].family} `"></span></p>
                    <!-- /ko -->
                    <!-- ko if: resource.telecom -->
                    <p>
                        Telecom:

                        <span data-bind="text: `${resource.telecom[0]} `"></span>
                    </p>
                    <!-- /ko -->
                    <!-- ko if: resource.address -->
                    <p>
                        Address: <span data-bind="text: `${resource.address[0]} `"></span>
                    </p>
                    <!-- /ko -->

                    <div>
                        <a class="btn btn-primary" data-bind="attr: { href: '/Person/Edit/' + resource.id}">Edit</a>
                        <button data-bind="click: deletePerson.bind($parent)" class="btn btn-danger">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @*<table class="table table-bordered table-hover text-center">
            <tbody>
                <tr>
                    <td></td>
                </tr>
                <tr>
                    <td></td>
                </tr>
            </tbody>
        </table>*@

</div>
@section Scripts {
    <script type="text/javascript">
        $(() => {
            const siteUrl = "https://hapi.fhir.org/baseR4/Person";
            var self = this;
            self.persons = null;

            self.deletePerson = function (pers) {
                let id = console.log(pers.resource.id);
                if (confirm(`You sure you want to delete this person with Id = ${id}?`)) {
                    $.ajax({
                        url: siteUrl,
                        type: 'DELETE',
                        contentType: "application/json",
                        data: { id: id },
                        success: (data) => {
                            alert("deleted successfully");
                            console.log(data);
                        },
                        error: (data) => {
                            alert("error");
                            console.log(data);
                        }
                    });
                }
            }

            $.ajax({
                url: siteUrl,
                type: 'GET',
                //contentType: "application/json",
                success: function (data) {
                    console.log(data);
                    console.log(data.entry);
                    self.persons = ko.observableArray(data.entry);
                    ko.applyBindings(self);
                },
                error: function (data) {
                    alert("error");
                    console.log(data);
                }
            });            
        });
    </script>
}